# 模型学习问题分析报告：为何数据多样但策略单一？

## 1. 问题背景
用户反馈：
1.  **数据集验证通过**：已确认采集的数据集包含多样化的目标位置和对应的机械臂轨迹。
2.  **现象依旧**：训练后的 ACT 模型在评估时，面对不同位置的目标，仍然执行固定的轨迹。

基于“数据没问题”的前提，我们将焦点转移到**模型学习（Model Learning）**和**训练过程**上。

## 2. 核心假设：为何模型忽略了视觉信息？

如果数据中 $Image \rightarrow Action$ 的映射是多样的，但模型学成了 $Constant \rightarrow Action$，说明模型**未能有效提取或利用图像特征**。

### 2.1. 视觉编码器失效 (Visual Encoder Failure)
ACT 使用 ResNet18 作为视觉骨干网络。如果这部分出了问题，模型就变成了“盲人”。
*   **预训练权重问题**: 如果加载的预训练权重不匹配，或者被错误地冻结（Frozen），导致卷积层无法适应新的任务场景。
*   **归一化不匹配**: 训练时图像预处理（如均值/方差归一化）与推理时不一致。
*   **特征维度坍塌**: 经过 Transformer 编码后，视觉特征可能被“淹没”在位置编码或关节信息（Proprioception）中。

### 2.2. 本体感觉过拟合 (Overfitting to Proprioception)
模型输入不仅有图像，还有机械臂当前的关节角度 (`qpos`)。
*   **现象**: 模型发现仅靠当前的关节角度就能预测下一刻的动作（在训练集上），因为训练集的轨迹虽然多样，但可能存在某种规律，或者模型“偷懒”只记住了平均轨迹。
*   **原因**: 视觉信号的学习难度远大于直接映射关节角度。如果 Loss 下降得太快，模型可能陷入了局部最优——即忽略图像，只做平滑的关节插值。

### 2.3. 损失函数掩盖问题 (Loss Function Masking)
ACT 的损失函数通常由两部分组成：
$$ L = L_{reconstruction} + \beta \cdot L_{KL} $$
*   **重构损失 ($L_{reconstruction}$)**: 预测动作与真实动作的 L1 距离。
*   **KL 散度 ($L_{KL}$)**: 潜在变量 $z$ 的分布与标准正态分布的距离。

**分析**:
*   如果 **KL 权重 ($\beta$) 过大**，模型会倾向于忽略输入（图像），直接从先验分布中采样，导致输出趋向于数据集的“平均动作”。
*   如果 **L1 损失主导**，且大部分轨迹在空间上比较接近，模型预测一个“平均轨迹”也能获得较低的 Loss，从而陷入局部极小值。

## 3. 深度排查建议

### 3.1. 检查 KL Weight (KL 散度权重)
*   **当前设置**: 你的命令中 `--kl_weight 10`。
*   **风险**: 权重过大可能导致“后验坍塌”（Posterior Collapse）。模型为了最小化 KL Loss，让编码器输出的信息量趋近于 0，导致 $z$ 不包含任何图像信息。
*   **建议**: 尝试降低 `kl_weight` 到 `1` 甚至 `0.1` 进行实验。

### 3.2. 检查视觉骨干网络 (Backbone)
*   **学习率**: 检查 `lr_backbone` 是否设置得太低（通常是 `1e-5`）。如果太低，ResNet 几乎不更新。
*   **冻结层**: 确认代码中没有意外冻结 ResNet 的参数。

### 3.3. 验证“盲操”基准 (Blind Baseline)
*   **实验**: 故意将输入图像全置为 0（黑色），然后运行评估。
*   **预期**: 如果“全黑图像”跑出来的轨迹和“正常图像”跑出来的轨迹**一模一样**，那就实锤了模型根本没在看图。

## 4. 损失函数可视化 (Loss Visualization)

为了直观判断训练是否正常，我们需要查看 Loss 曲线。
*   **正常曲线**: 训练 Loss 和验证 Loss 都应稳步下降。
*   **异常曲线**:
    *   Loss 迅速下降到一个值然后不动了（可能陷入平均轨迹）。
    *   验证 Loss 远大于训练 Loss（过拟合）。

请运行随附的 `plot_training_log.py` 脚本来提取并绘制 Loss 曲线。

由于训练日志被 WandB 存储为二进制格式，无法直接读取。请按照以下步骤操作：
1.  如果你保存了训练时的终端输出（Terminal Output），将其保存为 `train_log.txt`。
2.  运行命令：`python plot_training_log.py train_log.txt`。
3.  如果没有保存日志，请尝试使用 `wandb sync wandb/latest-run` 将日志同步到网页端查看。

---
**下一步行动**:
1. 运行 `plot_wandb_loss.py` 查看训练曲线。
2. 尝试将 `--kl_weight` 设为 1 重新训练。
3. 做“全黑图像”测试，验证模型是否真的在用视觉信息。
